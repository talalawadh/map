<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>برنامج الملاحة للرحلات — نسخة محسّنة تعمل</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Omnivore (KML/GPX) -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.1/leaflet-omnivore.min.js"></script>
  <style>
    :root {
      --card-bg: rgba(255, 255, 255, 0.98);
      --card-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
      --primary: #3498db;
      --primary-hover: #2980b9;
      --text: #2c3e50;
      --muted: #6b7280;
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
      color: var(--text);
      background: #f8fafc;
    }
    #map { width: 100vw; height: 100vh; }

    .controls {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: var(--card-bg);
      padding: 14px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      width: 320px;
      max-height: 92vh;
      overflow-y: auto;
      backdrop-filter: saturate(1.2) blur(2px);
    }
    .controls h3 { margin: 0 0 8px; font-size: 16px; font-weight: 700; }
    .row { margin-bottom: 10px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    select, input[type="text"], input[type="file"], button { width: 100%; }
    select, input, button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font: inherit;
      background: #fff;
    }
    input[type="range"] { padding: 0; }

    button.primary {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }
    button.primary:hover { background-color: var(--primary-hover); }
    button.ghost { background: #fff; border: 1px solid #e5e7eb; }

    .stack { display: grid; gap: 10px; }
    .inline { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .hint { font-size: 12px; color: var(--muted); }

    .info { margin-top: 8px; font-size: 14px; color: var(--text); }
    .divider { height: 1px; background: #e5e7eb; margin: 8px 0; }

    .toast {
      position: absolute; inset-inline-start: 50%; top: 12px; transform: translateX(-50%);
      background: #111827; color:#fff; padding: 10px 14px; border-radius: 999px; font-size: 13px;
      box-shadow: 0 8px 30px rgba(0,0,0,.2); opacity: 0; pointer-events: none; transition: opacity .25s ease;
      z-index: 1200;
    }
    .toast.show { opacity: 1; }

    @media (max-width: 640px){ .controls { width: calc(100vw - 24px); left: 12px; right: 12px; } }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls" role="region" aria-label="لوحة التحكم">
    <div class="stack">
      <h3>إعدادات الخريطة</h3>

      <div class="row">
        <label for="satellite-source">اختيار مصدر الصور (صور جوية):</label>
        <select id="satellite-source" aria-label="مصدر صور الأقمار">
          <option value="none" selected>بدون صور جوية (OSM فقط)</option>
          <option value="esri">Esri World Imagery</option>
          <option value="imagerie">ArcGIS Imagerie</option>
          <option value="google">صور قوقل (ساتلايت)</option>
        </select>
        <div class="hint">يمكنك التبديل فورًا بين طبقات الصور دون التأثير على بقية العناصر.</div>
      </div>

      <div class="row">
        <label for="satellite-opacity">شفافية صور الأقمار الصناعية: <span id="satellite-opacity-value">1</span></label>
        <input type="range" id="satellite-opacity" min="0" max="1" step="0.1" value="1" />
      </div>

      <div class="row">
        <label for="street-opacity">شفافية خريطة الشارع المفتوح: <span id="street-opacity-value">1</span></label>
        <input type="range" id="street-opacity" min="0" max="1" step="0.1" value="1" />
      </div>

      <div class="row inline">
        <button id="locate" class="ghost" title="الذهاب إلى موقعي الحالي">موقعي الحالي</button>
        <button id="fullscreen" class="ghost" title="عرض بملء الشاشة">ملء الشاشة</button>
        <button id="clear" class="primary" title="مسح العلامات والمسارات">مسح</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label for="search">بحث عن موقع (اسم مدينة/مكان):</label>
        <div class="inline">
          <input type="text" id="search" placeholder="مثال: الرياض" />
          <button id="search-btn" class="ghost" title="بحث">بحث</button>
        </div>
        <ul id="search-results" class="hint" style="list-style:none; padding:6px 0; margin:0; display:grid; gap:6px;"></ul>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label for="geojson-upload">تحميل مسار (GeoJSON / KML / GPX):</label>
        <input type="file" id="geojson-upload" accept=".geojson,.kml,.gpx" />
      </div>

      <div class="row">
        <label>الإحداثيات المحددة:</label>
        <div class="inline">
          <input type="text" id="coordinates" readonly placeholder="انقر على الخريطة" />
          <button id="copy-coordinates" class="ghost" title="نسخ الإحداثيات">نسخ</button>
        </div>
        <div class="hint" id="decimal-coords">—</div>
      </div>

      <div class="row info" id="distance-info">المسافة بين العلامتين: غير محددة</div>
      <div class="row info" id="weather-info">حالة الطقس: غير متوفرة</div>
      <div class="row info" id="traffic-info">حالة المرور: غير متوفرة</div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ============ الخريطة و الطبقات الأساسية ============
    const map = L.map('map', { zoomControl: true }).setView([23.8859, 45.0792], 6);

    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // طبقات صور جوية متعددة (نستخدم واحدة فعّالة في كل وقت)
    const esriImagery = L.tileLayer(
      'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: '&copy; Esri, USGS, NASA', opacity: 0, maxZoom: 19 }
    );

    const arcgisImagery = L.tileLayer(
      'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: '&copy; Esri, USGS, NASA', opacity: 0, maxZoom: 19 }
    );

    // طبقة صور الأقمار الصناعية من قوقل
    const googleImagery = L.tileLayer(
      'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
      {
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
        attribution: '&copy; <a href="https://www.google.com/earth/">Google Earth</a>',
        opacity: 0,
        maxZoom: 19
      }
    );

    const imageryLayers = {
      none: null,
      esri: esriImagery,
      imagerie: arcgisImagery,
      google: googleImagery
    };
    let activeImageryKey = 'none';

    // عناصر مساعدة
    const uploadsGroup = L.featureGroup().addTo(map); // للمسارات المرفوعة
    const markersGroup = L.featureGroup().addTo(map); // للعلامات والمسافات
    let distanceLine = null;

    // مقياس
    L.control.scale({ metric: true, imperial: false, position: 'bottomleft' }).addTo(map);

    // ============ أدوات الواجهة ============
    const $ = (id) => document.getElementById(id);
    const satelliteSelect = $('satellite-source');
    const satelliteRange = $('satellite-opacity');
    const satelliteValue = $('satellite-opacity-value');
    const streetRange = $('street-opacity');
    const streetValue = $('street-opacity-value');
    const coordsInput = $('coordinates');
    const decimalCoords = $('decimal-coords');
    const distanceInfo = $('distance-info');
    const weatherInfo = $('weather-info');
    const trafficInfo = $('traffic-info');
    const toast = $('toast');
    const fullscreenBtn = $('fullscreen');
    const searchInput = $('search');
    const searchBtn = $('search-btn');
    const searchResults = $('search-results');

    // قيم العرض الأولية للنصوص
    satelliteValue.textContent = satelliteRange.value;
    streetValue.textContent = streetRange.value;

    function showToast(msg) {
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 1800);
    }

    // زر ملء الشاشة
    if (fullscreenBtn) {
      fullscreenBtn.addEventListener('click', () => {
        const el = document.documentElement;
        if (!document.fullscreenElement) { el.requestFullscreen?.(); }
        else { document.exitFullscreen?.(); }
      });
    }

    // تغيير طبقة الصور دون إزالة بقية الطبقات
    satelliteSelect.addEventListener('change', (e) => {
      const key = e.target.value;
      if (key === activeImageryKey) return;
      // أخفِ القديمة إن وُجدت
      if (imageryLayers[activeImageryKey]) {
        imageryLayers[activeImageryKey].setOpacity(0);
        imageryLayers[activeImageryKey].remove();
      }
      // أظهر الجديدة إن لم تكن none
      if (imageryLayers[key]) {
        const v = parseFloat(satelliteRange.value);
        imageryLayers[key].setOpacity(isNaN(v) ? 1 : v);
        imageryLayers[key].addTo(map);
      }
      activeImageryKey = key;
      updateHashDebounced();
    });

    // التحكم في الشفافية
    satelliteRange.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      satelliteValue.textContent = v;
      if (imageryLayers[activeImageryKey]) imageryLayers[activeImageryKey].setOpacity(v);
    });
    streetRange.addEventListener('input', (e) => {
      const v = parseFloat(e.target.value);
      streetValue.textContent = v;
      streetLayer.setOpacity(v);
    });

    // نسخ الإحداثيات
    $('copy-coordinates').addEventListener('click', async () => {
      if (!coordsInput.value) return;
      try { await navigator.clipboard.writeText(coordsInput.value); showToast('تم نسخ الإحداثيات'); }
      catch { showToast('تعذّر النسخ'); }
    });

    // موقعي الحالي
    $('locate').addEventListener('click', () => {
      if (!navigator.geolocation) { showToast('المتصفح لا يدعم تحديد الموقع'); return; }
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude: lat, longitude: lng } = pos.coords;
        map.flyTo([lat, lng], 14);
        const me = L.circleMarker([lat, lng], { radius: 8, color: '#2563eb' }).addTo(markersGroup);
        me.bindTooltip('موقعي الحالي', { permanent: false });
        updateWeather(lat, lng);
      }, () => showToast('تعذّر تحديد الموقع'));
    });

    // مسح كل شيء (علامات + خط المسافة + مسارات مرفوعة)
    $('clear').addEventListener('click', () => {
      markersGroup.clearLayers();
      uploadsGroup.clearLayers();
      distanceLine = null;
      distanceInfo.textContent = 'المسافة بين العلامتين: غير محددة';
      coordsInput.value = '';
      decimalCoords.textContent = '—';
      updateHashDebounced();
    });

    // ============ التحميل (GeoJSON/KML/GPX) ============
    $('geojson-upload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = event.target.result;
        const ext = file.name.split('.').pop().toLowerCase();
        let layer = null;
        try {
          if (ext === 'geojson' || ext === 'json') {
            layer = L.geoJSON(JSON.parse(data));
          } else if (ext === 'kml') {
            layer = omnivore.kml.parse(data);
          } else if (ext === 'gpx') {
            layer = omnivore.gpx.parse(data);
          } else {
            alert('الصيغة غير مدعومة');
            return;
          }
          uploadsGroup.addLayer(layer);
          map.fitBounds(layer.getBounds(), { padding: [24, 24] });
          showToast('تم تحميل المسار');
          updateHashDebounced();
        } catch (err) {
          console.error(err);
          alert('حدث خطأ أثناء قراءة الملف');
        }
      };
      reader.readAsText(file);
      // إعادة تعيين نفس الملف لاحقًا
      e.target.value = '';
    });

    // ============ أدوات القياس و الإحداثيات ============
    const markers = [];

    function toDMS(degrees, isLat) {
      const dir = isLat ? (degrees >= 0 ? 'N' : 'S') : (degrees >= 0 ? 'E' : 'W');
      const abs = Math.abs(degrees);
      const d = Math.floor(abs);
      const mFloat = (abs - d) * 60;
      const m = Math.floor(mFloat);
      const s = ((mFloat - m) * 60).toFixed(1);
      return `${d}°${m}'${s}"${dir}`;
    }

    function updateWeather(lat, lng) {
      const apiKey = '92fc4c00bd8068695e51cee6b0f412c8'; // مفتاح OpenWeatherMap الذي زوّدتني به
      if (!apiKey || apiKey === 'API_KEY') { weatherInfo.textContent = 'حالة الطقس: (أضف مفتاح API)'; return; }
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${apiKey}&units=metric&lang=ar`;
      fetch(url).then(r => r.json()).then(data => {
        if (!data || !data.weather) { weatherInfo.textContent = 'حالة الطقس: غير متوفرة'; return; }
        const w = data.weather[0].description; const t = data.main.temp; const ws = data.wind?.speed;
        weatherInfo.textContent = `حالة الطقس: ${w}، ${t.toFixed(0)}°C${ws ? `، رياح ${ws} م/ث` : ''}`;
      }).catch(() => weatherInfo.textContent = 'حالة الطقس: غير متوفرة');
    }

    function formatDistance(meters) {
      if (meters < 1000) return `${meters.toFixed(0)} م`;
      return `${(meters / 1000).toFixed(2)} كم`;
    }

    function bearing(from, to) {
      const toRad = (d) => d * Math.PI / 180;
      const toDeg = (r) => r * 180 / Math.PI;
      const lat1 = toRad(from.lat), lat2 = toRad(to.lat);
      const dLon = toRad(to.lng - from.lng);
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      const brng = (toDeg(Math.atan2(y, x)) + 360) % 360;
      return brng; // درجات
    }

    map.on('click', (e) => {
      const { lat, lng } = e.latlng;
      const latDMS = toDMS(lat, true); const lngDMS = toDMS(lng, false);
      coordsInput.value = `${latDMS} ${lngDMS}`;
      decimalCoords.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

      if (markers.length === 2) {
        markers.forEach(m => markersGroup.removeLayer(m));
        markers.length = 0;
        if (distanceLine) { markersGroup.removeLayer(distanceLine); distanceLine = null; }
        distanceInfo.textContent = 'المسافة بين العلامتين: غير محددة';
      }
      const marker = L.marker([lat, lng], { draggable: true }).addTo(markersGroup);
      markers.push(marker);

      marker.on('drag', () => { if (markers.length === 2) { computeDistance(); } });
      marker.on('dragend', updateHashDebounced);

      if (markers.length === 2) { computeDistance(); }

      updateWeather(lat, lng);
      updateHashDebounced();
    });

    function computeDistance(){
      const a = markers[0].getLatLng();
      const b = markers[1].getLatLng();
      const d = a.distanceTo(b);
      if (distanceLine) markersGroup.removeLayer(distanceLine);
      distanceLine = L.polyline([a, b], { weight: 3 }).addTo(markersGroup);
      const br = bearing(a, b).toFixed(0);
      distanceInfo.textContent = `المسافة بين العلامتين: ${formatDistance(d)} — الاتجاه: ${br}°`;
      updateHashDebounced();
    }

    // ============ حالة المرور (Placeholder) ============
    trafficInfo.textContent = 'حالة المرور: تتطلب طبقة طرف ثالث (مثل خرائط جوجل/هير).';

    // ============ Geocoder بسيط باستخدام Nominatim ============
    async function geocode(q){
      if(!q) return [];
      const url = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&accept-language=ar&q=${encodeURIComponent(q)}`;
      try{
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        return await r.json();
      }catch{ return []; }
    }

    function renderSearch(results){
      searchResults.innerHTML = '';
      if(!results.length){ searchResults.innerHTML = '<li>لا نتائج</li>'; return; }
      results.forEach(item => {
        const li = document.createElement('li');
        li.style.cursor='pointer';
        li.textContent = item.display_name;
        li.title = item.display_name;
        li.addEventListener('click', () => {
          const lat = parseFloat(item.lat), lon = parseFloat(item.lon);
          map.flyTo([lat, lon], 13);
          showToast('تم الانتقال إلى البحث');
          updateHashDebounced();
        });
        searchResults.appendChild(li);
      });
    }

    searchBtn.addEventListener('click', async () => {
      const q = searchInput.value.trim();
      renderSearch(await geocode(q));
    });
    searchInput.addEventListener('keydown', async (e) => {
      if(e.key==='Enter'){ renderSearch(await geocode(searchInput.value.trim())); }
    });

    // ============ Permalink (حالة الخريطة في العنوان) ============
    function getState(){
      const c = map.getCenter();
      const z = map.getZoom();
      const s = [parseFloat(streetRange.value)||1, parseFloat(satelliteRange.value)||1];
      const m = markers.map(m=>{ const p = m.getLatLng(); return [p.lat, p.lng]; });
      return { c:[+c.lat.toFixed(6), +c.lng.toFixed(6), z], l: activeImageryKey, s, m };
    }

    let hashTimer = null;
    function updateHashDebounced(){
      clearTimeout(hashTimer);
      hashTimer = setTimeout(()=>{ location.hash = encodeURIComponent(JSON.stringify(getState())); }, 350);
    }

    function applyStateFromHash(){
      if(!location.hash || location.hash.length<2) return;
      try{
        const obj = JSON.parse(decodeURIComponent(location.hash.substring(1)));
        if(obj.c){ map.setView([obj.c[0], obj.c[1]], obj.c[2]||6); }
        if(obj.l && imageryLayers[obj.l] !== undefined){
          satelliteSelect.value = obj.l;
          satelliteSelect.dispatchEvent(new Event('change'));
        }
        if(Array.isArray(obj.s)){
          streetRange.value = obj.s[0]; streetValue.textContent=obj.s[0]; streetLayer.setOpacity(parseFloat(obj.s[0]));
          satelliteRange.value = obj.s[1]; satelliteValue.textContent=obj.s[1];
          if (imageryLayers[activeImageryKey]) imageryLayers[activeImageryKey].setOpacity(parseFloat(obj.s[1]));
        }
        if(Array.isArray(obj.m)){
          markersGroup.clearLayers(); markers.length=0; if(distanceLine){ markersGroup.removeLayer(distanceLine); distanceLine=null; }
          obj.m.slice(0,2).forEach(([lat,lng])=>{
            const marker = L.marker([lat,lng], { draggable:true }).addTo(markersGroup);
            markers.push(marker);
            marker.on('dragend', updateHashDebounced);
          });
          if(markers.length===2){ computeDistance(); }
        }
      }catch{ /* تجاهل أي خطأ */ }
    }

    map.on('moveend zoomend', updateHashDebounced);
    satelliteSelect.addEventListener('change', updateHashDebounced);
    streetRange.addEventListener('input', updateHashDebounced);
    satelliteRange.addEventListener('input', updateHashDebounced);
    markersGroup.on('layeradd', updateHashDebounced);
    markersGroup.on('layerremove', updateHashDebounced);

    applyStateFromHash();

    // فallback تلقائي إذا فشلت البلاطات
    ;[esriImagery, arcgisImagery, googleImagery].forEach(l => {
      l.on('tileerror', () => {
        showToast('تعذّر تحميل الصور الجوية — تم الإبقاء على خريطة الشارع');
        satelliteSelect.value = 'none';
        if (imageryLayers[activeImageryKey]) {
          imageryLayers[activeImageryKey].remove();
          activeImageryKey = 'none';
        }
        updateHashDebounced();
      });
    });

    // تلميحات لوحة المفاتيح الأساسية للوصولية
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'c' && (ev.ctrlKey || ev.metaKey)) {
        if (coordsInput.value) navigator.clipboard.writeText(coordsInput.value).then(() => showToast('تم نسخ الإحداثيات'));
      }
    });
  </script>
</body>
</html>
