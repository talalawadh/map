<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج الملاحة المتطور</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f4f7f6;
            color: #333;
        }

        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .controls-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 320px;
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease-in-out;
            transform: translateX(0);
        }
        
        /* حالة القائمة المصغرة */
        .controls-container.collapsed {
            width: 60px; /* عرض أصغر للقائمة المصغرة */
            padding: 10px;
            overflow: hidden; /* إخفاء المحتوى الزائد */
            pointer-events: none; /* تعطيل التفاعل مع العناصر المخفية */
        }

        .controls-container.collapsed .controls-group,
        .controls-container.collapsed h3,
        .controls-container.collapsed button:not(#toggle-controls-btn),
        .controls-container.collapsed label,
        .controls-container.collapsed select,
        .controls-container.collapsed input:not(#geojson-upload) { /* استثنى input file */
            display: none; /* إخفاء كل المحتوى باستثناء زر التصغير */
        }
        .controls-container.collapsed #geojson-upload {
             display: none; /* إخفاء زر رفع الملفات أيضاً */
        }


        @media (max-width: 768px) {
            .controls-container {
                width: calc(100% - 30px);
                left: 15px;
                right: 15px;
                top: 15px;
                max-height: calc(100vh - 30px);
                transform: translateX(calc(100% + 30px)); /* Hidden by default on mobile */
            }
            .controls-container.active {
                transform: translateX(0);
            }
            .menu-toggle {
                display: block;
            }
        }

        .controls-group {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .controls-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }

        select, input[type="text"], input[type="file"], input[type="range"], button {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.9em;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        select:focus, input[type="text"]:focus, input[type="range"]:focus, button:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        input[type="range"] {
            padding: 0;
            height: 25px;
            -webkit-appearance: none;
            background: #eee;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .range-value {
            display: inline-block;
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            color: #3498db;
            margin-top: 5px;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }

        .info-box {
            background-color: #e8f6fc;
            border: 1px solid #b3e0f2;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-box i {
            color: #3498db;
            font-size: 1.2em;
        }

        #coordinates-output {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #555;
            word-break: break-all;
        }

        .menu-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 1.2em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none; /* Hidden by default, shown on mobile */
        }
        .menu-toggle:hover {
            background-color: #2980b9;
        }

        /* زر التصغير والتكبير داخل لوحة التحكم */
        #toggle-controls-btn {
            position: absolute;
            top: 10px;
            right: 10px; /* على اليمين ليكون ظاهرًا حتى لو كانت القائمة مصغرة */
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%; /* دائري */
            background-color: #6c757d; /* لون مختلف للزر */
            font-size: 1.2em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1001; /* فوق العناصر الأخرى */
        }
        #toggle-controls-btn:hover {
            background-color: #5a6268;
        }
        /* إخفاء زر التصغير على الجوال لأن لدينا زر menu-toggle */
        @media (max-width: 768px) {
            #toggle-controls-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>

    <div class="controls-container" id="controls-container">
        <button id="toggle-controls-btn" title="تصغير/تكبير القائمة"><i class="fas fa-chevron-left"></i></button>
        <h3 style="text-align: center; color: #2c3e50; margin-top: 0;">برنامج الملاحة المتطور</h3>

        <div class="controls-group">
            <label for="base-map-source">اختيار خريطة الأساس:</label>
            <select id="base-map-source">
                <option value="osm">خريطة الشارع المفتوح</option>
                <option value="google-sat">Google Satellite</option>
                <option value="esri-sat">Esri World Imagery</option>
                <option value="topo">Topo Map</option>
            </select>
        </div>

        <div class="controls-group">
            <label for="geojson-upload">رفع ملف مسار (GeoJSON, KML, GPX):</label>
            <input type="file" id="geojson-upload" accept=".geojson,.kml,.gpx" />
            <button id="clear-map-layers"><i class="fas fa-eraser"></i> مسح جميع الطبقات</button>
        </div>
        
        <div class="controls-group">
            <label>الإحداثيات المحددة (DMS):</label>
            <div id="coordinates-output" style="margin-bottom: 10px;">انقر على الخريطة لتحديد الإحداثيات</div>
            <button id="copy-coordinates"><i class="fas fa-copy"></i> نسخ الإحداثيات</button>
        </div>

        <div class="controls-group">
            <label>حساب المسافة بين نقطتين:</label>
            <button id="start-distance-measure"><i class="fas fa-ruler-horizontal"></i> ابدأ قياس المسافة</button>
            <div class="info-box" id="distance-info"><i class="fas fa-info-circle"></i> المسافة: --</div>
        </div>

        <div class="controls-group">
            <label>التوجيه وحساب المسار:</label>
            <button id="add-route-point"><i class="fas fa-map-marker-alt"></i> إضافة نقطة مسار</button>
            <button id="get-route" style="background-color: #27ae60;"><i class="fas fa-road"></i> احصل على المسار</button>
            <div class="info-box" id="route-info"><i class="fas fa-route"></i> المسار: --</div>
            <p style="font-size: 0.8em; color: #777;">*انقر على "إضافة نقطة مسار" ثم انقر على الخريطة لتحديد النقاط. تحتاج على الأقل نقطتين.</p>
        </div>

        <div class="controls-group">
            <label>حالة الطقس للموقع الأخير:</label>
            <div class="info-box" id="weather-info"><i class="fas fa-cloud-sun"></i> الطقس: غير متوفرة</div>
        </div>

        <button id="locate-me"><i class="fas fa-location-arrow"></i> تحديد موقعي الحالي</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.1/leaflet-omnivore.min.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        // مفاتيح API (استبدلها بمفاتيحك الحقيقية)
        const OPENWEATHERMAP_API_KEY = 'YOUR_OPENWEATHERMAP_API_KEY'; 
        const OPENROUTESERVICE_API_KEY = 'YOUR_OPENROUTESERVICE_API_KEY'; 

        var map = L.map('map').setView([23.8859, 45.0792], 6); // إحداثيات المملكة العربية السعودية

        // تعريف طبقات الخرائط الأساسية
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        });

        var googleSatLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            attribution: '&copy; <a href="https://www.google.com/earth/">Google Earth</a>'
        });

        var esriSatLayer = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>, <a href="https://www.usgs.gov/">USGS</a>, <a href="https://www.nasa.gov/">NASA</a>',
            maxZoom: 19
        });

        var topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });

        // إضافة طبقة OSM كطبقة افتراضية
        osmLayer.addTo(map);

        // وظيفة لتغيير طبقة الخريطة الأساسية
        document.getElementById('base-map-source').addEventListener('change', function(event) {
            var selectedSource = event.target.value;

            // إزالة جميع طبقات الأساس
            map.eachLayer(function(layer) {
                if (layer !== currentGeojsonLayer && layer !== routeLayer && !distanceMarkers.includes(layer) && !routeMarkers.includes(layer) && layer !== userLocationMarker) {
                    map.removeLayer(layer);
                }
            });

            if (selectedSource === 'osm') {
                osmLayer.addTo(map);
            } else if (selectedSource === 'google-sat') {
                googleSatLayer.addTo(map);
            } else if (selectedSource === 'esri-sat') {
                esriSatLayer.addTo(map);
            } else if (selectedSource === 'topo') {
                topoLayer.addTo(map);
            }
        });

        // إضافة Geocoder (بحث عن الأماكن)
        L.Control.geocoder({
            defaultMarkGeocoded: false
        }).addTo(map)
        .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]).addTo(map);
            map.fitBounds(poly.getBounds());
            // يمكن إضافة marker أو معلومات إضافية للموقع المبحث عنه
        });

        var currentGeojsonLayer;
        var distanceMarkers = [];
        var routeMarkers = [];
        var routeLayer;
        var userLocationMarker;

        // تحميل ملفات GeoJSON/KML/GPX
        document.getElementById('geojson-upload').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(event) {
                var data = event.target.result;
                var extension = file.name.split('.').pop().toLowerCase();

                // إزالة الطبقة السابقة إذا وجدت
                if (currentGeojsonLayer) {
                    map.removeLayer(currentGeojsonLayer);
                }

                if (extension === 'geojson') {
                    currentGeojsonLayer = L.geoJSON(JSON.parse(data)).addTo(map);
                    map.fitBounds(currentGeojsonLayer.getBounds());
                } else if (extension === 'kml' || extension === 'gpx') {
                    if (extension === 'kml') {
                        currentGeojsonLayer = omnivore.kml.parse(data).addTo(map);
                    } else if (extension === 'gpx') {
                        currentGeojsonLayer = omnivore.gpx.parse(data).addTo(map);
                    }
                    map.fitBounds(currentGeojsonLayer.getBounds());
                } else {
                    alert('الصيغة غير مدعومة. يرجى رفع ملفات GeoJSON أو KML أو GPX.');
                }
            };
            reader.readAsText(file);
        });

        // مسح جميع الطبقات (باستثناء طبقة الأساس)
        document.getElementById('clear-map-layers').addEventListener('click', function() {
            if (currentGeojsonLayer) {
                map.removeLayer(currentGeojsonLayer);
                currentGeojsonLayer = null;
            }
            distanceMarkers.forEach(marker => map.removeLayer(marker));
            distanceMarkers = [];
            routeMarkers.forEach(marker => map.removeLayer(marker));
            routeMarkers = [];
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            document.getElementById('distance-info').innerHTML = '<i class="fas fa-info-circle"></i> المسافة: --';
            document.getElementById('route-info').innerHTML = '<i class="fas fa-route"></i> المسار: --';
            document.getElementById('coordinates-output').textContent = 'انقر على الخريطة لتحديد الإحداثيات';
            document.getElementById('weather-info').innerHTML = '<i class="fas fa-cloud-sun"></i> الطقس: غير متوفرة';
            alert('تم مسح جميع الطبقات المضافة بنجاح.');
        });


        // عرض الإحداثيات عند النقر على الخريطة
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            function toDMS(degrees, isLatitude) {
                var direction = isLatitude ? (degrees >= 0 ? "N" : "S") : (degrees >= 0 ? "E" : "W");
                var absoluteDegrees = Math.abs(degrees);
                var d = Math.floor(absoluteDegrees);
                var m = Math.floor((absoluteDegrees - d) * 60);
                var s = ((absoluteDegrees - d - m / 60) * 3600).toFixed(1);
                return `${d}°${m}'${s}"${direction}`;
            }

            var latDMS = toDMS(lat, true);
            var lngDMS = toDMS(lng, false);

            document.getElementById('coordinates-output').textContent = `${latDMS} ${lngDMS}`;
            showWeather(lat, lng); // تحديث معلومات الطقس للموقع الأخير
        });

        // نسخ الإحداثيات
        document.getElementById('copy-coordinates').addEventListener('click', function() {
            var coordinatesText = document.getElementById('coordinates-output').textContent;
            if (coordinatesText && coordinatesText !== 'انقر على الخريطة لتحديد الإحداثيات') {
                navigator.clipboard.writeText(coordinatesText).then(function() {
                    alert('تم نسخ الإحداثيات!');
                }, function(err) {
                    alert('فشل في نسخ الإحداثيات: ' + err);
                });
            } else {
                alert('لا توجد إحداثيات لنسخها بعد. انقر على الخريطة أولاً.');
            }
        });

        // قياس المسافة بين نقطتين
        var measuringDistance = false;
        document.getElementById('start-distance-measure').addEventListener('click', function() {
            if (distanceMarkers.length > 0) { // مسح القياسات السابقة
                distanceMarkers.forEach(marker => map.removeLayer(marker));
                distanceMarkers = [];
                document.getElementById('distance-info').innerHTML = '<i class="fas fa-info-circle"></i> المسافة: --';
            }
            measuringDistance = true;
            alert('انقر على نقطتين على الخريطة لقياس المسافة بينهما.');
        });

        map.on('click', function(e) {
            if (measuringDistance) {
                var marker = L.marker(e.latlng, { draggable: true }).addTo(map);
                distanceMarkers.push(marker);

                marker.on('dragend', updateDistance);

                if (distanceMarkers.length === 2) {
                    measuringDistance = false;
                    updateDistance();
                }
            }
        });

        function updateDistance() {
            if (distanceMarkers.length === 2) {
                var latlng1 = distanceMarkers[0].getLatLng();
                var latlng2 = distanceMarkers[1].getLatLng();
                var distance = latlng1.distanceTo(latlng2);
                document.getElementById('distance-info').innerHTML = `<i class="fas fa-info-circle"></i> المسافة: ${(distance / 1000).toFixed(2)} كم (${distance.toFixed(0)} متر)`;
            }
        }

        // عرض حالة الطقس
        function showWeather(lat, lng) {
            if (OPENWEATHERMAP_API_KEY === 'YOUR_OPENWEATHERMAP_API_KEY') {
                document.getElementById('weather-info').innerHTML = '<i class="fas fa-exclamation-triangle"></i> الرجاء إضافة مفتاح OpenWeatherMap API.';
                return;
            }
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHERMAP_API_KEY}&units=metric&lang=ar`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const weatherDescription = data.weather[0].description;
                    const temp = data.main.temp.toFixed(1);
                    const feelsLike = data.main.feels_like.toFixed(1);
                    const humidity = data.main.humidity;
                    const windSpeed = (data.wind.speed * 3.6).toFixed(1); // m/s to km/h

                    document.getElementById('weather-info').innerHTML = `
                        <i class="fas fa-cloud-sun"></i> 
                        الطقس: ${weatherDescription}،
                        الحرارة: ${temp}°C (تبدو: ${feelsLike}°C)،
                        الرطوبة: ${humidity}%،
                        الرياح: ${windSpeed} كم/ساعة
                    `;
                })
                .catch(error => {
                    console.error("Error fetching weather data:", error);
                    document.getElementById('weather-info
